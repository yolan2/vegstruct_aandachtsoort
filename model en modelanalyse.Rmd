---
title: "Model Vegetatiestructuur & Visualisatie"
output: html_document
---

```{r setup, include=FALSE}
# Global options
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)

# Required libraries
library(tidyverse)
library(terra)
library(INLA)
library(data.table)
library(spdep)
library(Matrix)
library(raster)
```

## Load Canopy Height Model (CHM) Metrics
```{r load_chm}
# Define input paths
input_folder <- "C:/Users/yolan/OneDrive/Documenten/UGENT/Master/Stage/hoogtemetrieken/"
plot_dir     <- "C:/Users/yolan/OneDrive/Documenten/UGENT/Master/Stage/R/aandachtsoorten_results/plots"

# Create plot directory if needed
if (!dir.exists(plot_dir)) dir.create(plot_dir, recursive = TRUE)

# Load CHM metrics as a named list
chm_metrics_25 <- list(
  #shannon = rast(file.path(input_folder, "chm_shannon.tif")),
  mean    = rast(file.path(input_folder, "chm_mean25.tif")),
  #moran   = rast(file.path(input_folder, "chm_localmoran.tif")),
  #fisher  = rast(file.path(input_folder, "chm_fisher.tif")),
  #max     = rast(file.path(input_folder, "chm_max.tif")),
  #min     = rast(file.path(input_folder, "chm_min.tif")),
  begrazing = rast(file.path(input_folder, "grazing_density.tif"))
)

chm_metrics_5 <- list(
  #shannon = rast(file.path(input_folder, "chm_shannon.tif")),
  mean    = rast(file.path(input_folder, "chm_mean5.tif")),
  #moran   = rast(file.path(input_folder, "chm_localmoran.tif")),
  #fisher  = rast(file.path(input_folder, "chm_fisher.tif")),
  #max     = rast(file.path(input_folder, "chm_max.tif")),
  #min     = rast(file.path(input_folder, "chm_min.tif")),
  #edgness_quant = rast(file.path(input_folder, "wh_vh1m_edges_quantile.tif")),
  edgness_avg = rast(file.path(input_folder, "wh_vh1m_edges_aggregated.tif"))
)

crss = " +proj=lcc +lat_0=90 +lon_0=4.36748666666667 +lat_1=49.8333339 +lat_2=51.1666672333333 +x_0=150000.01256 +y_0=5400088.4378 +ellps=intl +units=m +no_defs  "

cell_size <- 5 #default celgroote voor dit project

chm_ras1 = raster('wh_vh1m.tif', crs = crss)
chm_ras1[chm_ras1 < 0] <- NA

chm_ras5 = aggregate(chm_ras1, fun = "mean", fact = cell_size/res(chm_ras1))
```

```{r}
# Calculate correlations between all CHM metrics
calculate_chm_correlations <- function(chm_metrics) {
  message("Calculating correlations between CHM metrics")

  # Stack all CHM metrics into a single raster stack
  chm_stack <- rast(chm_metrics)

  # Extract values as a dataframe
  chm_df <- as.data.frame(terra::values(chm_stack, na.rm = TRUE))
  colnames(chm_df) <- names(chm_metrics)

  # Remove any rows with NA values
  chm_df <- chm_df[complete.cases(chm_df),]

  # Calculate correlation matrix
  cor_matrix <- cor(chm_df, method = "pearson")

  return(cor_matrix)
}


cor_matrix <- calculate_chm_correlations(chm_metrics_5)
print(cor_matrix)
```


## Functions: Process & Model per Species: doet enkel analyses van resolutie 25m
```{r functions}
# Analyze one species: compute metrics and fit binary & positive models
analyze_species_25 <- function(path, chm_metrics) {
  species_name <- gsub("_combined.tif", "", basename(path), fixed = TRUE)
  message("Processing: ", species_name)

  ras <- rast(path)
  ras <- aggregate(ras, fun = "mean", fact = 5)
  crs(ras) <- crss
  ras[ras < 0.5] <- 0

  # Mask distant zeros
  bin_ras <- ifel(ras > 0, 1, NA)
  d0 <- distance(bin_ras)
  ras[d0 >= 70 & ras == 0] <- NA
  ras_bin <- ifel(ras > 1, 1, 0)

  results <- list()

  # Loop over CHM metrics
  for (m in names(chm_metrics)) {
    message("  Metric: ", m)

    chm <- chm_metrics[[m]]
    plot(ras * 100, main = paste("Species:", species_name))

    # Stack and clean
    message("Stacking and cleaning rasters")
    stk <- c(chm, ras_bin, ras)
    names(stk) <- c("chm", "species_binary", "species")
    vals <- terra::values(stk, dataframe = TRUE, na.rm = TRUE)
    coords <- terra::xyFromCell(stk, which(!is.na(vals[[1]])))
    df <- as.data.table(cbind(coords, vals))

    if (nrow(df) == 0 || sum(df$species_binary) == 0) next

    if (sum(df$species > 1 & df$chm > 0) < 20) {
      warning("Less than 20 overlapping values between species and CHM — skipping species.")
      next
    }

    message("Calculating neighborhood structure")

    coords <- as.matrix(df[, .(x, y)])
    k <- 8
    repeat {
      nb <- knearneigh(coords, k = k) |> knn2nb(sym = TRUE)
      if (all(card(nb) > 0) || k > 16) break
      k <- k + 4
    }

    if (k > 16) next

    W <- as(nb2mat(nb, style = "B"), "sparseMatrix")
    diag(W) <- 0

    if (nrow(W) != nrow(df)) next

    message("Creating INLA graph")
    df[, spatial_id := .I]
    g <- inla.read.graph(W)

    message("Fitting binary model")
    mb <- inla(
      species_binary ~ chm + f(spatial_id, model = "besag", graph = g),
      data = df, family = "binomial",
      control.compute = list(dic = TRUE, waic = TRUE)
    )

    message("Fitting positive model")
    dfp <- df[species > 0]
    mp <- NULL
    if (nrow(dfp) > 0) {
      mp <- inla(
        species ~ chm + f(spatial_id, model = "besag", graph = g),
        data = dfp, family = "gamma",
        control.compute = list(dic = TRUE, waic = TRUE)
      )
    }

    results[[m]] <- list(binary_model = mb, positive_model = mp)
  }

  # Full Model with all CHM metrics (outside loop)
  message("Fitting full model with all CHM metrics")
  full_stk <- rast(chm_metrics)
  full_stk <- c(full_stk, ras_bin, ras)
  names(full_stk) <- c(names(chm_metrics), "species_binary", "species")

  full_vals <- terra::values(full_stk, dataframe = TRUE, na.rm = TRUE)
  full_df <- as.data.table(full_vals)

  chm_formula <- paste(names(chm_metrics), collapse = " + ")

  mb_full <- inla(
    as.formula(paste("species_binary ~", chm_formula)),
    data = full_df, 
    family = "binomial",
    control.compute = list(dic = TRUE, waic = TRUE)
  )

  dfp_full <- full_df[species > 0]
  mp_full <- NULL
  if (nrow(dfp_full) > 0) {
    mp_full <- inla(
      as.formula(paste("species ~", chm_formula)),
      data = dfp_full, 
      family = "gamma",
      control.compute = list(dic = TRUE, waic = TRUE)
    )
  }

  results$full_model <- list(binary_model_full = mb_full, positive_model_full = mp_full)

  return(results)
}

```

TER INFO: OP 5m resolutie is er wel echt iets te veel data. Hoge kans dat je computer vastloopt.

analyses van resolutie 5m
```{r}
# Analyze one species: compute metrics and fit binary & positive models
analyze_species_5 <- function(path, chm_metrics) {
  species_name <- gsub("_combined.tif", "", basename(path), fixed = TRUE)
  message("Processing: ", species_name)

  ras <- rast(path)
  ras[ras < 0.5] <- 0
  crs(ras) <- crss

  # Mask distant zeros
  bin_ras <- ifel(ras > 0.5, 1, NA)
  d0 <- distance(bin_ras)
  ras[d0 >= 0 & ras == 0] <- NA
  ras_bin <- ifel(ras > 1, 1, 0)

  results <- list()

  # Loop over CHM metrics
  for (m in names(chm_metrics)) {
    message("  Metric: ", m)

    chm <- chm_metrics[[m]]

    # Stack and clean
    message("Stacking and cleaning rasters")
    stk <- c(chm, ras_bin, ras)
    names(stk) <- c("chm", "species_binary", "species")
    vals <- terra::values(stk, dataframe = TRUE, na.rm = TRUE)
    coords <- terra::xyFromCell(stk, which(!is.na(vals[[1]])))
    df <- as.data.table(cbind(coords, vals))

    if (nrow(df) == 0 || sum(df$species_binary) == 0) next

    if (sum(df$species > 1 & df$chm > 0) < 20) {
      warning("Less than 20 overlapping values between species and CHM — skipping species.")
      next
    }

    message("Calculating neighborhood structure")

    coords <- as.matrix(df[, .(x, y)])
    k <- 8
    nb <- knearneigh(coords, k = k) |> knn2nb(sym = TRUE)

    W <- as(nb2mat(nb, style = "B"), "sparseMatrix")
    diag(W) <- 0

    if (nrow(W) != nrow(df)) next

    message("Creating INLA graph")
    df[, spatial_id := .I]
    g <- inla.read.graph(W)

    message("Fitting binary model")
    mb <- inla(
      species_binary ~ chm + f(spatial_id, model = "besag", graph = g),
      data = df, family = "binomial",
      control.compute = list(dic = TRUE, waic = TRUE)
    )

    message("Fitting positive model")
    dfp <- df[species > 0]
    mp <- NULL
    if (nrow(dfp) > 0) {
      mp <- inla(
        species ~ chm + f(spatial_id, model = "besag", graph = g),
        data = dfp, family = "gamma",
        control.compute = list(dic = TRUE, waic = TRUE)
      )
    }

    results[[m]] <- list(binary_model = mb, positive_model = mp)
  }

  # Full Model with all CHM metrics (outside loop)
  message("Fitting full model with all CHM metrics")
  full_stk <- rast(chm_metrics)
  full_stk <- c(full_stk, ras_bin, ras)
  names(full_stk) <- c(names(chm_metrics), "species_binary", "species")

  full_vals <- terra::values(full_stk, dataframe = TRUE, na.rm = TRUE)
  full_df <- as.data.table(full_vals)

  chm_formula <- paste(names(chm_metrics), collapse = " + ")

  mb_full <- inla(
    as.formula(paste("species_binary ~", chm_formula)),
    data = full_df, 
    family = "binomial",
    control.compute = list(dic = TRUE, waic = TRUE)
  )

  dfp_full <- full_df[species > 0]
  mp_full <- NULL
  if (nrow(dfp_full) > 0) {
    mp_full <- inla(
      as.formula(paste("species ~", chm_formula)),
      data = dfp_full, 
      family = "gamma",
      control.compute = list(dic = TRUE, waic = TRUE)
    )
  }

  results$full_model <- list(binary_model_full = mb_full, positive_model_full = mp_full)

  return(results)
}

```

Hier kan je het model eindelijk runnen. Dit is echter het zwaarste stuk van heel het project. Doe dit dus niet zomaar! Om tijd te besparen kan je de test data (alternatieve species_folder) gebruiken. Hier gebruik je dan een suset van de data.

```{r process_all, message=TRUE, warning=TRUE}
# Apply analyze_species across all TIFF files
chm_metrics <- chm_metrics_5 #kies 5 (m) of 25  (m) resolutie

process_all_species <- function(dir, chm_metrics) {
  all <- list.files(dir, full.names = TRUE)
  tif <- all[endsWith(all, "_combined.tif")]
  out <- list()
  for (f in tif) {
    out[[basename(f)]] <- analyze_species_5(f, chm_metrics)#kies opnieuw 5 (m) of 25  (m) resolutie
  }
  return(out)
}

# Run modeling
species_folder <- "C:/Users/yolan/OneDrive/Documenten/UGENT/Master/Stage/R/aandachtsoorten/"
#species_folder <- "C:/Users/yolan/OneDrive/Documenten/UGENT/Master/Stage/R/aandachtsoorten_test/"
all_results <- process_all_species(species_folder, chm_metrics)
```




## Visualization of positive data
```{r run_all}
library(dplyr)
library(ggplot2)
library(tibble)

# Function to plot and save the gamma model
plot_gamma_model <- function(sp, mn, model, plot_dir) {
  cat("✅ Plotting model for:", sp, mn, "\n")
  
  # Extract model coefficients
  b0 <- model$summary.fixed["(Intercept)", "mean"]
  b1 <- model$summary.fixed[2, "mean"]  # Second coefficient is the main variable
  prec <- model$summary.hyperpar[1, "mean"]
  
  cat("✅ Model coefficients: Intercept =", b0, " | Slope =", b1, " | Precision =", prec, "\n")
  
  # Generate the grid for prediction (adjust range as needed)
  grid <- seq(0, 10, length.out = 100)  # Adjust the range as needed for your variable
  
  # Calculate predictions and confidence intervals
  linp <- b0 + b1 * grid
  mp <- exp(linp)
  lo <- qgamma(0.05, shape = prec, scale = mp / prec)
  hi <- qgamma(0.95, shape = prec, scale = mp / prec)
  pd <- tibble(x = grid, fit = mp, lower = lo, upper = hi)
  
  # Calculate p-value for the model slope
  est <- b1
  se <- model$summary.fixed[2, "sd"]
  z <- est / se
  pval <- 2 * (1 - pnorm(abs(z)))
  
  cat("✅ Plotting model with p-value:", format.pval(pval, digits = 3), "for", sp, mn, "\n")
  
  # Plot the model with the model name as title
  p2 <- ggplot(pd, aes(x = x, y = fit)) +
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
    geom_line() +
    labs(title = paste("Model:", mn), x = "Predictor (Grid)", y = "Abundance") +
    theme_minimal() +
    annotate(
      "text",
      x = max(grid),
      y = max(mp),
      label = paste0("p = ", format.pval(pval, digits = 2)),
      hjust = 1, vjust = 1,
      size = 4
    )
  
  # Save the plot
  output_path <- file.path(plot_dir, paste0(sp, "_", mn, "_gamma.png"))
  cat("✅ Attempting to save plot at:", output_path, "\n")
  
  tryCatch({
    ggsave(output_path, p2, width = 8, height = 6, dpi = 300)
    cat("✅ Plot saved successfully at:", output_path, "\n")
  }, error = function(e) {
    cat("❌ Error saving plot:", e$message, "\n")
  })
}

# Main Loop: Processing all species and all models
for (sp in names(all_results)) {
  res <- all_results[[sp]]  # res is a list of models per metric
  
  cat("\nProcessing species:", sp, "\n")
  
  for (mn in names(res)) {
    mr <- res[[mn]]
    
    # Skip if no positive model
    if (is.null(mr$positive_model)) {
      cat("❌ Skipping", mn, "- No positive model\n")
      next
    }
    
    cat("✅ Processing model:", mn, "\n")
    
    # Extract the model
    model <- mr$positive_model
    
    # Plot and save
    plot_gamma_model(sp, mn, model, plot_dir)
  }
}



```

```{r}
  saveRDS(
    res,
    file = file.path(plot_dir, paste0(sp, "_all_metrics_res.rds"))
  )
```
Results of binary data. 
```{r}

library(dplyr)
library(tibble)
library(knitr)


# For each species file, run analyze_species() and pull significant binary predictors
species_files <- list.files(species_folder)
binary_sig_summary_all <- bind_rows(
  lapply(species_files, function(f) {
    sp  <- sub("_combined_final_raster.tif", "", basename(f), fixed = TRUE)
    res <- all_results[[sp]]
    print(sp)
    
    # For each metric in that species, extract binary_model fixed effects
    bind_rows(
      lapply(names(res), function(mn) {
        bm <- res[[mn]]$binary_model
        if (is.null(bm)) return(NULL)
        
        fe <- as.data.frame(bm$summary.fixed) %>%
          rownames_to_column("Predictor") %>%
          rename(
            mean    = mean,
            lower90 = `0.025quant`,
            upper90 = `0.975quant`
          ) %>%
          mutate(
            Species = sp,
            Metric  = mn
          ) %>%
          dplyr::select(Species, Metric, Predictor, mean, lower90, upper90)
        
        fe
      })
    )
  })
)

# Print
if (nrow(binary_sig_summary_all) > 0) {
  kable(
    binary_sig_summary_all,
    caption = "Significant Binary‐Model Predictors by Species and Metric"
  )
} else {
  cat("No significant binary‐model predictors found across any species.\n")
}

```

```{r}
df_results <- as.data.frame(binary_sig_summary_all)

# inspect
print(head(df_results))

csv_file <- file.path(plot_dir, "binary_sig_summary_all.csv")
write.csv2(df_results, csv_file, row.names = FALSE)
cat("Written:", csv_file, "\n")
```
Hier combineren we het logistische (binaire) model en het gaussiaanse model. We nemen als het ware de som van de twee modellen.
```{r}
for (sp in names(all_results)) {
  res <- all_results[[sp]]

  for (mn in names(res)) {
    mr <- res[[mn]]
    if (is.null(mr$combined_effect)) next

    df <- mr$data
    var <- "chm"
    grid <- seq(min(df[[var]]), max(df[[var]]), length.out = 100)

    b <- mr$combined_effect$mean
    se <- mr$combined_effect$se
    z <- b / se
    pval <- mr$combined_effect$pval

    y <- exp(b * grid)  # transform to expected abundance

    pd <- tibble(x = grid, fit = y)

    p_comb <- ggplot(pd, aes(x = x, y = fit)) +
      geom_line() +
      geom_point(data = df[df$species > 0, ], aes(x = .data[[var]], y = species), alpha = 0.3) +
      labs(
        title = paste("Combined Effect (Binary + Gamma):", sp, mn),
        x = var, y = "Expected abundance (unscaled)"
      ) +
      annotate(
        "text",
        x = max(df[[var]], na.rm = TRUE),
        y = max(df$species, na.rm = TRUE),
        label = paste0("p = ", format.pval(pval, digits = 2)),
        hjust = 1, vjust = 1,
        size = 4
      ) +
      theme_minimal()

    plot(p_comb)

    ggsave(file.path(plot_dir, paste0(sp, "_", mn, "_combined_effect.png")), p_comb, width = 8, height = 6, dpi = 300)
  }
}

```

```{r}
combined_summary <- bind_rows(
  lapply(names(all_results), function(sp) {
    res <- all_results[[sp]]
    bind_rows(
      lapply(names(res), function(mn) {
        ce <- res[[mn]]$combined_effect
        if (is.null(ce)) return(NULL)
        tibble(
          Species = sp,
          Metric = mn,
          Mean = ce$mean,
          SE = ce$se,
          Pval = ce$pval
        )
      })
    )
  })
)

# Show as nice table
kable(
  combined_summary,
  caption = "Combined Effect (Binary + Positive Model) by Species and Metric"
)

```

