---
title: "analysis_vegetationstructuremodel"
author: "Yolan Bosteels"
date: "2025-04-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

OPGELET DIT SCRIPT RUNT \>2h

```{r}
library(ggplot2)
library(data.table)

# ==== Load all individual result files ====

output_dir <- "C:/Users/yolan/OneDrive/Documenten/UGENT/Master/Stage/R/aandachtsoorten_results/"
rds_files <- list.files(output_dir, pattern = "_results\\.rds$", full.names = TRUE)

# Create a folder for plots
plot_dir <- file.path(output_dir, "plots")
if (!dir.exists(plot_dir)) dir.create(plot_dir)

# Load all .rds files into a named list
results <- list()
for (file in rds_files) {
  print(basename(file))
  species_name <- basename(file)
  results[[species_name]] <- readRDS(file)
}

# ==== Loop over each species and plot ====

for (sp_name in names(results)) {
  print(paste("Processing species:", sp_name))  # Print statement for current species
  
  sp_result <- results[[sp_name]]
  model <- sp_result$positive_model

  # Skip if no model
  if (is.null(model)) next

  clean_sp_name <- gsub("_results\\.rds$", "", sp_name)

  # ----------------- Coefficient Plot -----------------
  fixed_effects <- as.data.frame(model$summary.fixed)
  colnames(fixed_effects) <- make.names(colnames(fixed_effects))  # Clean colnames
  fixed_effects$Predictor <- rownames(fixed_effects)  # Save original names

  p_coef <- ggplot(fixed_effects, aes(y = Predictor, x = mean)) +  # FLIP axes
    geom_pointrange(
      aes(xmin = X0.025quant, xmax = X0.975quant),
      size = 1, color = "blue"
    ) +
    labs(
      title = paste("Effect Estimates for", clean_sp_name),
      y = "Predictor",
      x = "Effect size (log-scale)"
    ) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "red") +
    theme_minimal()

  # Save coefficient plot
  coef_plot_path <- file.path(plot_dir, paste0(clean_sp_name, "_coefficients.png"))
  ggsave(coef_plot_path, plot = p_coef, width = 8, height = 6, dpi = 300)

  # ----------------- Gamma Prediction Plot -----------------
  data <- as.data.frame(model$.args$data)

  # Automatically detect the predictor variable (it is the second variable after species)
  predictors <- setdiff(names(data), "species")
  if (length(predictors) == 0) next  # No predictor found
  predictor_var <- predictors[1]  # Assume first predictor
  
  # Clean data
  data <- na.omit(data[, c(predictor_var, "species")])

  if (nrow(data) < 5) next

  beta0 <- model$summary.fixed["(Intercept)", "mean"]
  beta1 <- model$summary.fixed[predictor_var, "mean"]
  precision <- model$summary.hyperpar["Precision for the Gamma observations", "mean"]

  pred_grid <- seq(min(data[[predictor_var]]), max(data[[predictor_var]]), length.out = 100)
  linear_pred <- beta0 + beta1 * pred_grid
  mean_pred <- exp(linear_pred)
  var_pred <- mean_pred^2 / precision
  lower_ci <- qgamma(0.05, shape = precision, scale = mean_pred/precision)
  upper_ci <- qgamma(0.95, shape = precision, scale = mean_pred/precision)

  plot_data <- data.frame(
    predictor = pred_grid,
    predicted = mean_pred,
    lower = lower_ci,
    upper = upper_ci
  )

  p_pred <- ggplot(plot_data, aes(y = predictor)) +  # FLIP axes
    geom_ribbon(aes(xmin = lower, xmax = upper), fill = "red", alpha = 0.2) +
    geom_line(aes(x = predicted), color = "red", linewidth = 1) +
    geom_point(data = data[data$species > 0, ], aes(x = species),
               alpha = 0.3, color = "grey40") +
    labs(
      title = paste("Gamma Model Fit for", clean_sp_name),
      subtitle = paste("Predictor:", predictor_var),
      y = predictor_var,
      x = "Species Abundance"
    ) +
    theme_minimal() +
    theme(plot.subtitle = element_text(size = 9, color = "grey30"))

  # Save prediction plot
  pred_plot_path <- file.path(plot_dir, paste0(clean_sp_name, "_gamma_fit.png"))
  ggsave(pred_plot_path, plot = p_pred, width = 8, height = 6, dpi = 300)
}


```

## 
